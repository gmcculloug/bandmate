<div class="page-header">
    <h2 class="page-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -4px; margin-right: 8px;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
        Song Catalog<% if @show_archived %> - Archived<% end %> (<%= @song_catalogs.count %>)
    </h2>
    <% unless @show_archived %>
        <div class="page-actions">
            <% if current_band %>
                <a href="/bands/<%= current_band.id %>/copy_songs" class="btn btn-primary"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>Copy Songs to <%= current_band.name %></a>
            <% end %>
            <a href="/song_catalogs/new" class="btn btn-success"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>Add Song</a>
        </div>
    <% end %>
</div>


<div style="margin-bottom: 20px;">
    <div style="position: relative; max-width: 400px;">
        <input type="text" id="search-input" value="<%= @search %>" placeholder="Search song catalog by title or artist..." style="width: 100%; padding: 10px 40px 10px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
        <% if @search.present? %>
            <a href="#" onclick="clearSearch(); return false;" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #718096; font-size: 18px; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></a>
        <% end %>
    </div>
</div>

<script>
let searchTimeout;

document.getElementById('search-input').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        filterSongs();
    }, 500);
});

document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        filterSongs();
    }
});

function filterSongs() {
    const searchTerm = document.getElementById('search-input').value;
    const currentUrl = new URL(window.location);
    
    if (searchTerm.trim() === '') {
        currentUrl.searchParams.delete('search');
    } else {
        currentUrl.searchParams.set('search', searchTerm);
    }
    
    window.location.href = currentUrl.toString();
}

function clearSearch() {
    const searchInput = document.getElementById('search-input');
    searchInput.value = '';
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.delete('search');
    window.location.href = currentUrl.toString();
    
    // Focus will be restored by the DOMContentLoaded handler when the page reloads
}

// Focus the search input when page loads and add global keyboard handling
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        // Check if we came from a clear action (no search param but input was just cleared)
        const urlParams = new URLSearchParams(window.location.search);
        const hasSearchTerm = searchInput.value.trim() !== '';
        const wasCleared = !urlParams.has('search') && document.referrer.includes('search=');

        if (hasSearchTerm || wasCleared) {
            // Small delay to ensure the page is fully loaded
            setTimeout(function() {
                searchInput.focus();
                // Move cursor to end of text
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
            }, 100);
        }
    }

    // Global keyboard event handler
    document.addEventListener('keydown', function(e) {
        const activeElement = document.activeElement;
        const isTypingInInput = activeElement.tagName === 'INPUT' ||
                                activeElement.tagName === 'TEXTAREA' ||
                                activeElement.isContentEditable;
        const hasModifier = e.altKey || e.ctrlKey || e.metaKey;

        // Handle ESC key to clear search
        if (e.key === 'Escape') {
            if (searchInput && searchInput.value.trim() !== '') {
                e.preventDefault();
                clearSearch();
                return;
            }
        }

        // Global text input handling - direct text to search box
        if (!isTypingInInput && !hasModifier && searchInput) {
            // Check if it's a printable character or backspace/delete
            const isPrintableChar = e.key.length === 1;
            const isBackspace = e.key === 'Backspace';
            const isDelete = e.key === 'Delete';

            if (isPrintableChar) {
                e.preventDefault();
                searchInput.focus();

                // Clear existing content and add the new character
                searchInput.value = e.key;

                // Move cursor to end
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);

                // Trigger input event to start search
                const inputEvent = new Event('input');
                searchInput.dispatchEvent(inputEvent);
            } else if ((isBackspace || isDelete) && searchInput.value.trim() !== '') {
                e.preventDefault();
                searchInput.focus();

                if (isBackspace) {
                    // Remove last character
                    searchInput.value = searchInput.value.slice(0, -1);
                } else if (isDelete) {
                    // Clear all content
                    searchInput.value = '';
                }

                // Move cursor to end
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);

                // Trigger input event
                const inputEvent = new Event('input');
                searchInput.dispatchEvent(inputEvent);
            }
        }
    });
});
</script>

<% if @search.present? %>
    <div style="margin-bottom: 20px; padding: 10px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
        <p style="margin: 0; color: #4a5568;">
            Showing results for "<strong><%= @search %></strong>"
            (<%= @song_catalogs.count %> song<%= @song_catalogs.count == 1 ? '' : 's' %>)
        </p>
    </div>
<% end %>

<div style="margin-bottom: 20px; padding: 15px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38a169;">
    <p style="margin: 0; color: #2f855a; font-weight: 500;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>This is the song catalog that all bands can use. Add songs here to make them available to everyone, or browse to copy songs to your band's repertoire.
    </p>
</div>

<% if @song_catalogs.any? %>
    <div style="display: flex; flex-direction: column; gap: 8px;">
        <% @song_catalogs.each do |song_catalog| %>
            <div class="song-card" style="padding: 15px; margin-bottom: 0; cursor: pointer;" onclick="window.location.href='/song_catalogs/<%= song_catalog.id %>'">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: bold; color: #2d3748; margin-bottom: 5px; word-break: break-word;">
                            <%= song_catalog.title %>
                            <% if song_catalog.artist.present? %>
                                <span style="color: #718096; font-weight: normal; font-size: 0.9rem;"> ‚Ä¢ <%= song_catalog.artist %></span>
                            <% end %>
                            <% if song_catalog.archived? && !@show_archived %>
                                <span style="background: #e53e3e; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 8px; font-weight: normal;">üóÉÔ∏è ARCHIVED</span>
                            <% end %>
                        </div>
                        <% if @show_archived && song_catalog.archived? && song_catalog.archived_at.present? %>
                            <div style="font-size: 0.8rem; color: #718096; margin-bottom: 8px;">
                                üì¶ Archived on <%= song_catalog.archived_at.strftime('%B %d, %Y at %I:%M %p') %>
                            </div>
                        <% end %>
                        <div style="font-size: 0.8rem; color: #a0aec0; display: flex; flex-wrap: wrap; gap: 5px;">
                            <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px;">
                                <%= song_catalog.key %>
                            </span>

                            <% if song_catalog.tempo %>
                                <span style="background: #38a169; color: white; padding: 2px 6px; border-radius: 10px;">
                                    <%= song_catalog.tempo %> BPM
                                </span>
                            <% end %>
                            <% if song_catalog.genre.present? %>
                                <span style="background: #ed8936; color: white; padding: 2px 6px; border-radius: 10px;">
                                    <%= song_catalog.genre %>
                                </span>
                            <% end %>
                        </div>
                    </div>
                    <div class="actions" onclick="event.stopPropagation();" style="margin-left: 15px; display: flex; gap: 5px; flex-shrink: 0;">
                        <% if song_catalog.url.present? %>
                            <a href="<%= song_catalog.url %>" target="_blank" class="btn" style="padding: 6px 12px; font-size: 0.8rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -1px;"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg></a>
                        <% end %>

                        <% if current_band && !@show_archived && !@existing_catalog_ids.include?(song_catalog.id) %>
                            <form method="post" action="/songs/copy_single_from_catalog" style="display: inline;">
                                <input type="hidden" name="song_catalog_id" value="<%= song_catalog.id %>">
                                <input type="hidden" name="search" value="<%= @search %>">
                                <button type="submit" class="btn btn-success" style="padding: 6px 12px; font-size: 0.8rem; display: inline-flex; align-items: center; justify-content: center; gap: 4px;"
                                        onclick="this.disabled=true; this.textContent='Adding...'; this.form.submit();"
                                        title="Add this song to <%= current_band.name %>">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -1px;">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add to Band
                                </button>
                            </form>
                        <% elsif current_band && !@show_archived && @existing_catalog_ids.include?(song_catalog.id) %>
                            <span class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: #e2e8f0; color: #718096; cursor: not-allowed; display: inline-flex; align-items: center; gap: 4px;" title="Already in <%= current_band.name %>">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -1px;">
                                    <path d="m9 12 2 2 4-4"></path>
                                    <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.12 0 4.07.74 5.61 1.98"></path>
                                </svg>
                                In Band
                            </span>
                        <% end %>

                        <% if @show_archived && song_catalog.archived? %>
                            <form method="POST" action="/song_catalogs/<%= song_catalog.id %>/unarchive" style="display: inline;" onsubmit="return confirm('Are you sure you want to unarchive this song?');">
                                <button type="submit" class="btn btn-success btn-small" style="font-size: 0.8rem;">üìÇ Unarchive</button>
                            </form>
                        <% end %>
                    </div>
                </div>
            </div>
        <% end %>
    </div>
<% else %>
    <div class="card">
        <% if @show_archived %>
            <h3>No archived songs</h3>
            <p>You haven't archived any songs yet.</p>
            <a href="?<%= @search.present? ? "search=#{CGI.escape(@search)}" : "" %>" class="btn">Back to Active Songs</a>
        <% else %>
            <h3>No songs in catalog yet!</h3>
            <p>Get started by adding the first song to the song catalog. This will make it available for all bands to copy and use.</p>
            <a href="/song_catalogs/new" class="btn btn-success">Add First Song to Catalog</a>
        <% end %>
    </div>
<% end %>

<% if @show_archived %>
    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
        <a href="?<%= @search.present? ? "search=#{CGI.escape(@search)}" : "" %>" style="color: #718096; text-decoration: none; font-size: 0.9rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>Back to Active Songs</a>
    </div>
<% elsif SongCatalog.archived.any? %>
    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
        <a href="?<%= @search.present? ? "search=#{CGI.escape(@search)}&" : "" %>show_archived=true" style="color: #718096; text-decoration: none; font-size: 0.9rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><polyline points="21,8 21,21 3,21 3,8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>View Archived Songs</a>
    </div>
<% end %>