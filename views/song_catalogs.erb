<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
    <h2>üåç Song Catalog</h2>
    <a href="/song_catalogs/new" class="btn btn-success">‚ûï Add New Song</a>
</div>

<div style="margin-bottom: 20px;">
    <div style="position: relative; max-width: 400px;">
        <input type="text" id="search-input" value="<%= @search %>" placeholder="Search song catalog by title or artist..." style="width: 100%; padding: 10px 40px 10px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
        <% if @search.present? %>
            <a href="#" onclick="clearSearch(); return false;" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #718096; font-size: 18px; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px;">‚úï</a>
        <% end %>
    </div>
</div>

<script>
let searchTimeout;

document.getElementById('search-input').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        filterSongs();
    }, 500);
});

document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        filterSongs();
    }
});

function filterSongs() {
    const searchTerm = document.getElementById('search-input').value;
    const currentUrl = new URL(window.location);
    
    if (searchTerm.trim() === '') {
        currentUrl.searchParams.delete('search');
    } else {
        currentUrl.searchParams.set('search', searchTerm);
    }
    
    window.location.href = currentUrl.toString();
}

function clearSearch() {
    const searchInput = document.getElementById('search-input');
    searchInput.value = '';
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.delete('search');
    window.location.href = currentUrl.toString();
    
    // Focus will be restored by the DOMContentLoaded handler when the page reloads
}

// Focus the search input when page loads
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        // Check if we came from a clear action (no search param but input was just cleared)
        const urlParams = new URLSearchParams(window.location.search);
        const hasSearchTerm = searchInput.value.trim() !== '';
        const wasCleared = !urlParams.has('search') && document.referrer.includes('search=');
        
        if (hasSearchTerm || wasCleared) {
            // Small delay to ensure the page is fully loaded
            setTimeout(function() {
                searchInput.focus();
                // Move cursor to end of text
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
            }, 100);
        }
    }
});
</script>

<% if @search.present? %>
    <div style="margin-bottom: 20px; padding: 10px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
        <p style="margin: 0; color: #4a5568;">
            Showing results for "<strong><%= @search %></strong>"
            (<%= @song_catalogs.count %> song<%= @song_catalogs.count == 1 ? '' : 's' %>)
        </p>
    </div>
<% end %>

<div style="margin-bottom: 20px; padding: 15px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38a169;">
    <p style="margin: 0; color: #2f855a; font-weight: 500;">
        ‚ÑπÔ∏è This is the song catalog that all bands can use. Add songs here to make them available to everyone, or browse to copy songs to your band's repertoire.
    </p>
</div>

<% if @song_catalogs.any? %>
    <div style="display: flex; flex-direction: column; gap: 8px;">
        <% @song_catalogs.each do |song_catalog| %>
            <div class="song-card" style="padding: 15px; margin-bottom: 0; cursor: pointer;" onclick="window.location.href='/song_catalogs/<%= song_catalog.id %>'">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: bold; color: #2d3748; margin-bottom: 5px; word-break: break-word;">
                            <%= song_catalog.title %>
                            <% if song_catalog.artist.present? %>
                                <span style="color: #718096; font-weight: normal; font-size: 0.9rem;"> ‚Ä¢ <%= song_catalog.artist %></span>
                            <% end %>
                        </div>
                        <div style="font-size: 0.8rem; color: #a0aec0; display: flex; flex-wrap: wrap; gap: 5px;">
                            <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px;">
                                <%= song_catalog.key %>
                            </span>

                            <% if song_catalog.tempo %>
                                <span style="background: #38a169; color: white; padding: 2px 6px; border-radius: 10px;">
                                    <%= song_catalog.tempo %> BPM
                                </span>
                            <% end %>
                            <% if song_catalog.genre.present? %>
                                <span style="background: #ed8936; color: white; padding: 2px 6px; border-radius: 10px;">
                                    <%= song_catalog.genre %>
                                </span>
                            <% end %>
                        </div>
                    </div>
                    <div class="actions" onclick="event.stopPropagation();" style="margin-left: 15px; display: flex; gap: 5px; flex-shrink: 0;">
                        <% if song_catalog.url.present? %>
                            <a href="<%= song_catalog.url %>" target="_blank" class="btn" style="padding: 6px 12px; font-size: 0.8rem;">üéµ</a>
                        <% end %>
                    </div>
                </div>
            </div>
        <% end %>
    </div>
<% else %>
    <div class="card">
        <h3>No songs in catalog yet!</h3>
        <p>Get started by adding the first song to the song catalog. This will make it available for all bands to copy and use.</p>
        <a href="/song_catalogs/new" class="btn btn-success">Add First Song to Catalog</a>
    </div>
<% end %>