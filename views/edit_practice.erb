<h2>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -4px; margin-right: 8px;">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
    </svg>
    Edit Practice Session
</h2>

<% if defined?(@error) && @error %>
    <div class="errors">
        <%= @error %>
    </div>
<% end %>

<form method="POST" action="/practices/<%= @practice.id %>" class="card">
    <input type="hidden" name="_method" value="PUT">

    <div class="form-group">
        <label for="practice_title">Practice Title (Optional)</label>
        <input type="text" id="practice_title" name="title" placeholder="e.g., Weekly Practice, Pre-Gig Rehearsal" value="<%= @practice.title %>">
    </div>

    <div class="form-group">
        <label for="practice_date_range" style="margin-bottom: 10px; display: block;">Practice Dates *</label>
        <div style="position: relative;">
            <input type="text" id="practice_date_range" name="date_range"
                   placeholder="Click to select date range or single day..."
                   readonly required
                   style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; background: white; font-size: 16px;">
            <!-- Hidden inputs for form submission -->
            <input type="hidden" id="practice_start_date" name="start_date" value="<%= @practice.start_date %>">
            <input type="hidden" id="practice_end_date" name="end_date" value="<%= @practice.end_date %>">
        </div>
        <div id="date_feedback" style="display: none; margin-top: 8px; font-size: 0.9em; padding: 8px 12px; border-radius: 4px;"></div>
        <div style="color: #718096; font-size: 0.9em; margin-top: 5px;">
            Select a single day or drag to select a date range for scheduling availability.
        </div>
    </div>

    <div class="form-group">
        <label for="practice_description">Description (Optional)</label>
        <textarea id="practice_description" name="description" rows="3" placeholder="Add any details about the practice session, location, or what you'll be working on..."><%= @practice.description %></textarea>
    </div>

    <div class="form-group">
        <label for="practice_start_time">Practice Time</label>
        <div class="modern-time-control">
            <div class="preset-times">
                <button type="button" class="time-preset-btn" data-time="18:00">6:00 PM</button>
                <button type="button" class="time-preset-btn" data-time="19:00">7:00 PM</button>
                <button type="button" class="time-preset-btn" data-time="20:00">8:00 PM</button>
                <button type="button" class="time-preset-btn" data-time="21:00">9:00 PM</button>
            </div>
            <div class="time-input-row">
                <%
                  # Display time in user's timezone
                  user_timezone_time = @practice.timezone_aware_start_time(current_user.user_timezone) if @practice.start_time
                %>
                <input type="text" id="practice_start_time" name="start_time" placeholder="Select practice time..." readonly
                       data-time="<%= user_timezone_time&.strftime('%H:%M') %>"
                       value="<%= user_timezone_time&.strftime('%-l:%M %p') if user_timezone_time %>">
                <select id="practice_duration" name="duration" class="duration-selector">
                    <option value="">Duration</option>
                    <option value="60" <%= 'selected' if @practice.duration == 60 %>>1 hour</option>
                    <option value="90" <%= 'selected' if @practice.duration == 90 %>>1.5 hours</option>
                    <option value="120" <%= 'selected' if @practice.duration == 120 %>>2 hours</option>
                    <option value="150" <%= 'selected' if @practice.duration == 150 %>>2.5 hours</option>
                    <option value="180" <%= 'selected' if @practice.duration == 180 %>>3 hours</option>
                    <option value="240" <%= 'selected' if @practice.duration == 240 %>>4 hours</option>
                </select>
            </div>
            <div class="duration-info" id="duration-info" style="display: none;"></div>
        </div>
        <div style="color: #718096; font-size: 0.9em; margin-top: 5px;">
            Select when practice starts and how long it lasts (both optional)
        </div>
    </div>

    <% if @practice.status == 'active' && (@practice.best_day || @practice.possible_dates_display) %>
        <div style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #0369a1; margin-bottom: 10px; display: flex; align-items: center;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="m9 12 2 2 4-4"></path>
                </svg>
                Current Availability Status:
            </h4>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <% if @practice.best_day %>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: rgba(56, 161, 105, 0.1); color: #38a169; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500;">
                            Best: <%= @practice.best_day %>
                        </span>
                    </div>
                <% end %>
                <% if @practice.possible_dates_display %>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: rgba(102, 126, 234, 0.1); color: #667eea; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500;">
                            Possible: <%= @practice.possible_dates_display %>
                        </span>
                    </div>
                <% end %>
            </div>
            <p style="color: #0369a1; font-size: 0.85em; margin: 10px 0 0 0; line-height: 1.4;">
                <% if @practice.response_count > 0 %>
                    <%= @practice.response_count %>/<%= @practice.total_band_members %> members have responded.
                <% else %>
                    No members have responded yet.
                <% end %>
                Changing dates will clear existing responses.
            </p>
        </div>
    <% end %>

    <% if @practice.practice_availabilities.exists? %>
        <div style="background: #fff4e6; border: 1px solid #fed7aa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #c2410c; margin-bottom: 10px; display: flex; align-items: center;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <path d="m21 16-4 4-4-4"></path>
                    <path d="M14 12h6"></path>
                    <circle cx="10" cy="12" r="8"></circle>
                </svg>
                Important Note:
            </h4>
            <p style="color: #9a3412; font-size: 0.9em; margin: 0; line-height: 1.6;">
                This practice session already has member availability responses. If you change the dates, all existing availability responses will be cleared and members will need to respond again.
            </p>
        </div>
    <% end %>

    <div class="actions">
        <button type="submit" class="btn btn-success">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;">
                <path d="M20 6L9 17l-5-5"></path>
            </svg>
            Update Practice Session
        </button>
        <a href="/practices/<%= @practice.id %>" class="btn">Cancel</a>
    </div>
</form>

<script>
// Calculate days difference reliably, avoiding timezone issues
function calculateDaysDifference(startDate, endDate) {
    // Use UTC time to ensure consistent calculation across timezones
    const startUTC = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const endUTC = Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

    // Calculate difference in days, adding 1 to include both start and end dates
    const daysDiff = Math.floor((endUTC - startUTC) / (1000 * 60 * 60 * 24)) + 1;
    return daysDiff;
}

// Initialize Flatpickr when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const startTimeInput = document.getElementById('practice_start_time');
    const durationSelect = document.getElementById('practice_duration');
    const durationInfo = document.getElementById('duration-info');
    const presetTimeBtns = document.querySelectorAll('.time-preset-btn');
    let startTimePicker;

    // Initialize Flatpickr for time input
    const startTime24 = startTimeInput.getAttribute('data-time');
    startTimePicker = flatpickr(startTimeInput, {
        enableTime: true,
        noCalendar: true,
        dateFormat: "h:i K",
        time_24hr: false,
        minuteIncrement: 15,
        defaultDate: startTime24 ? convertTo12Hour(startTime24) : null,
        onChange: function(selectedDates, dateStr) {
            // Update data-time attribute in real-time
            if (selectedDates.length > 0) {
                const date = selectedDates[0];
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                startTimeInput.setAttribute('data-time', `${hours}:${minutes}`);

                // Recalculate end time immediately if duration is selected
                if (durationSelect.value && durationSelect.value !== '') {
                    calculateEndTime();
                }
            }
        },
        onClose: function(selectedDates, dateStr) {
            // Store as 24-hour format for form submission
            if (selectedDates.length > 0) {
                const date = selectedDates[0];
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                startTimeInput.setAttribute('data-time', `${hours}:${minutes}`);
            }

            updatePresetButtons();

            // Always recalculate end time if duration is selected
            if (durationSelect.value && durationSelect.value !== '') {
                calculateEndTime();
            }
        }
    });

    // Initialize form state on load
    initializeFormState();

    // Preset time buttons
    presetTimeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const time24 = this.dataset.time;
            const [hours, minutes] = time24.split(':');

            // Set time in Flatpickr
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            startTimePicker.setDate(date);

            // Store 24-hour format
            startTimeInput.setAttribute('data-time', time24);

            // Update button states
            presetTimeBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Calculate end time if duration is selected
            if (durationSelect.value) {
                calculateEndTime();
            }
        });
    });

    // Duration selection
    durationSelect.addEventListener('change', function() {
        if (this.value === '') {
            durationInfo.style.display = 'none';
        } else {
            durationInfo.style.display = 'block';
            calculateEndTime();
        }
    });

    // Form submission - convert display values to 24-hour format
    document.querySelector('form').addEventListener('submit', function() {
        const startTime24 = startTimeInput.getAttribute('data-time');

        if (startTime24) {
            startTimeInput.name = 'start_time';
            startTimeInput.value = startTime24;
        }
    });

    function convertTo12Hour(time24) {
        if (!time24) return null;
        const [hours, minutes] = time24.split(':');
        const date = new Date();
        date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        return date;
    }

    function initializeFormState() {
        const startTime24 = startTimeInput.getAttribute('data-time');
        const durationValue = durationSelect.value;

        // Highlight active preset if start time matches
        if (startTime24) {
            presetTimeBtns.forEach(btn => {
                if (btn.dataset.time === startTime24) {
                    btn.classList.add('active');
                }
            });
        }

        // Show end time if both start time and duration are set
        if (startTime24 && durationValue) {
            durationInfo.style.display = 'block';
            calculateEndTime();
        }
    }

    function updatePresetButtons() {
        const currentTime = startTimeInput.getAttribute('data-time');
        presetTimeBtns.forEach(btn => {
            if (btn.dataset.time === currentTime) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function calculateEndTime() {
        const startTime24 = startTimeInput.getAttribute('data-time');
        const duration = parseInt(durationSelect.value);

        if (startTime24 && duration) {
            const [hours, minutes] = startTime24.split(':');
            const startDate = new Date();
            startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            const endDate = new Date(startDate.getTime() + duration * 60000);
            const endHours = endDate.getHours().toString().padStart(2, '0');
            const endMinutes = endDate.getMinutes().toString().padStart(2, '0');
            const endTime24 = `${endHours}:${endMinutes}`;

            // Update duration display
            const endTime12h = formatTime12Hour(endTime24);
            durationInfo.textContent = `Ends at ${endTime12h}`;
        }
    }

    function formatTime12Hour(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
    }

    // Original calendar logic
    const startInput = document.getElementById('practice_start_date');
    const endInput = document.getElementById('practice_end_date');
    const feedback = document.getElementById('date_feedback');

    // Set initial values if they exist, converting to Date objects
    let initialDates = [];
    if (startInput.value && endInput.value) {
        // Create dates and validate they're not invalid
        const startDate = new Date(startInput.value);
        const endDate = new Date(endInput.value);

        if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
            initialDates = [startDate];
            if (startInput.value !== endInput.value) {
                initialDates.push(endDate);
            }
        }
    }

    // Initialize Flatpickr range picker
    const fp = flatpickr("#practice_date_range", {
        mode: "range",
        dateFormat: "M j, Y",
        defaultDate: initialDates,
        enableTime: false,

        // Ensure dates are displayed when picker is ready
        onReady: function(selectedDates, dateStr, instance) {
            if (selectedDates.length > 0) {
                // Manually trigger the display update when the picker is ready
                setTimeout(function() {
                    const startDate = selectedDates[0];
                    const endDate = selectedDates.length > 1 ? selectedDates[1] : selectedDates[0];
                    const isSameDay = startDate.getTime() === endDate.getTime();

                    if (isSameDay) {
                        feedback.style.cssText = 'display: block; color: #38a169; background: #f0fff4; border: 1px solid #9ae6b4;';
                        feedback.textContent = `Single day confirmed: ${startDate.toDateString()}`;
                    } else {
                        const daysDiff = calculateDaysDifference(startDate, endDate);
                        feedback.style.cssText = 'display: block; color: #38a169; background: #f0fff4; border: 1px solid #9ae6b4;';
                        feedback.textContent = `Practice period: ${daysDiff} day${daysDiff > 1 ? 's' : ''} (${startDate.toDateString()} to ${endDate.toDateString()})`;
                    }
                }, 50);
            }
        },

        // Custom behavior for single day selection
        onDayCreate: function(dObj, dStr, fp, dayElem) {
            // Add double-click behavior for better single-day selection
            dayElem.addEventListener('dblclick', function(e) {
                e.preventDefault();
                fp.setDate([dayElem.dateObj, dayElem.dateObj], true);
            });
        },

        onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 0) {
                // No dates selected
                feedback.style.display = 'none';
                startInput.value = '';
                endInput.value = '';

            } else if (selectedDates.length === 1) {
                // Single date selected - waiting for second date or treat as single day
                feedback.style.cssText = 'display: block; color: #3182ce; background: #ebf8ff; border: 1px solid #90cdf4;';
                feedback.textContent = 'Select another date for a range, or double-click to confirm single day';

                // Set as single day temporarily
                const dateStr = selectedDates[0].toISOString().split('T')[0];
                startInput.value = dateStr;
                endInput.value = dateStr;

            } else if (selectedDates.length === 2) {
                // Range selected or single day confirmed
                const startDate = selectedDates[0];
                const endDate = selectedDates[1];
                const isSameDay = startDate.getTime() === endDate.getTime();

                startInput.value = startDate.toISOString().split('T')[0];
                endInput.value = endDate.toISOString().split('T')[0];

                if (isSameDay) {
                    feedback.style.cssText = 'display: block; color: #38a169; background: #f0fff4; border: 1px solid #9ae6b4;';
                    feedback.textContent = `Single day confirmed: ${startDate.toDateString()}`;
                } else {
                    const daysDiff = calculateDaysDifference(startDate, endDate);
                    feedback.style.cssText = 'display: block; color: #38a169; background: #f0fff4; border: 1px solid #9ae6b4;';
                    feedback.textContent = `Practice period: ${daysDiff} day${daysDiff > 1 ? 's' : ''} (${startDate.toDateString()} to ${endDate.toDateString()})`;
                }
            }
        }
    });
});

// Form validation before submit
document.querySelector('form').addEventListener('submit', function(e) {
    const startInput = document.getElementById('practice_start_date');
    const endInput = document.getElementById('practice_end_date');

    if (!startInput.value || !endInput.value) {
        e.preventDefault();
        alert('Please select practice dates before submitting.');
    }
});
</script>

<style>
/* Flatpickr date range picker styling */
#practice_date_range:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    outline: none;
}

/* Style the Flatpickr calendar to match your design */
.flatpickr-calendar {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 8px !important;
    overflow: hidden;
}

.flatpickr-calendar .flatpickr-month {
    background: #667eea !important;
    color: white !important;
}

.flatpickr-calendar .flatpickr-weekday {
    background: #4a5568 !important;
    color: white !important;
}

/* Range selection styling */
.flatpickr-day.selected:first-child,
.flatpickr-day.selected:last-child {
    background: #667eea !important;
    border-color: #667eea !important;
    color: white !important;
}

.flatpickr-day.inRange {
    background: #e0e7ff !important;
    border-color: #c7d2fe !important;
    color: #4f46e5 !important;
    box-shadow: none !important;
}

.flatpickr-day.startRange,
.flatpickr-day.endRange {
    background: #667eea !important;
    border-color: #667eea !important;
    color: white !important;
}

/* Hover effects */
.flatpickr-day:hover {
    background: #f0f9ff !important;
    border-color: #3b82f6 !important;
}

.flatpickr-day.selected:hover,
.flatpickr-day.startRange:hover,
.flatpickr-day.endRange:hover {
    background: #4f46e5 !important;
    border-color: #4f46e5 !important;
}

/* Previous/Next month navigation */
.flatpickr-prev-month,
.flatpickr-next-month {
    fill: white !important;
}

.flatpickr-prev-month:hover,
.flatpickr-next-month:hover {
    fill: #e0e7ff !important;
}
</style>