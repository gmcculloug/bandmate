<% if params[:error] == 'copy_failed' %>
    <div class="errors" style="margin-bottom: 20px;">
        <p>Failed to copy gig. Please try again.</p>
    </div>
<% end %>

<% unless @gig %>
    <div class="errors" style="margin-bottom: 20px;">
        <p>Set list not found.</p>
    </div>
    <a href="/gigs" class="btn">Back to Gigs</a>
    <% return %>
<% end %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 10px;">
    <h2>ðŸ“‹ <%= @gig.name %></h2>
    <div class="actions">
        <a href="/gigs/<%= @gig.id %>/edit" class="btn">Edit</a>
        <a href="/gigs/<%= @gig.id %>/print" class="btn" target="_blank">Print Set List</a>
        <form method="POST" action="/gigs/<%= @gig.id %>/copy" style="display: inline;">
            <button type="submit" class="btn" onclick="return confirm('Copy this gig?')">ðŸ“‹ Copy</button>
        </form>
        <a href="/gigs" class="btn">Back to Gigs</a>
    </div>
</div>

<div class="card">
    <% if @gig && ((@gig.venue && @gig.venue.present?) || @gig.performance_date.present? || @gig.start_time.present?) %>
        <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 8px;">
            <h4>Performance Details</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                <% if @gig.venue && @gig.venue.present? %>
                    <div class="detail-item">
                        <span class="detail-label">Venue:</span> 
                        <a href="/venues/<%= @gig.venue.id %>" style="color: #667eea; text-decoration: none;"><%= @gig.venue.name %></a>
                    </div>
                <% end %>
                <% if @gig.performance_date.present? %>
                    <div class="detail-item">
                        <span class="detail-label">Date:</span> <%= @gig.performance_date.strftime('%B %d, %Y') %>
                    </div>
                <% end %>
                <% if @gig.start_time.present? %>
                    <div class="detail-item">
                        <span class="detail-label">Start Time:</span> <%= @gig.start_time.strftime('%I:%M %p') %>
                    </div>
                <% end %>
                <% if @gig.end_time.present? %>
                    <div class="detail-item">
                        <span class="detail-label">End Time:</span> <%= @gig.end_time.strftime('%I:%M %p') %>
                    </div>
                <% end %>
            </div>
        </div>
    <% end %>

    <% if @gig.notes.present? %>
        <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 8px;">
            <h4>Notes</h4>
            <p><%= @gig.notes %></p>
        </div>
    <% end %>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h3>Songs (<%= @gig.songs.count %>)</h3>
        <a href="/gigs/<%= @gig.id %>/manage_songs" class="btn">Manage Songs</a>
    </div>

    <% if @gig.songs.any? %>
        <% 
          gig_songs_by_set = @gig.gig_songs.includes(:song).order(:set_number, :position).group_by(&:set_number)
          max_set = gig_songs_by_set.keys.max || 1
        %>
        
        <% (1..max_set).each do |set_number| %>
          <% if gig_songs_by_set[set_number] %>
            <div style="margin-bottom: 25px;">
              <h4 style="color: #2d3748; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0;">
                Set <%= set_number %> (<%= gig_songs_by_set[set_number].count %> songs)
              </h4>
              
              <% gig_songs_by_set[set_number].each_with_index do |gig_song, index| %>
                <div class="song-card" style="margin-bottom: 4px; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer;" onclick="window.location.href='/songs/<%= gig_song.song.id %>'">
                  <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px;">
                      <span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 12px; font-weight: bold; min-width: 25px; text-align: center; font-size: 0.85rem; flex-shrink: 0;">
                        <%= index + 1 %>
                      </span>
                      <div style="font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; flex: 1;">
                        <%= gig_song.song.title %>
                        <% if gig_song.song.artist.present? %>
                          <span style="color: #718096; font-weight: normal; font-size: 0.9rem;"> â€¢ <%= gig_song.song.artist %></span>
                        <% end %>
                      </div>
                      <div style="font-size: 0.85rem; color: #4a5568; flex-shrink: 0;">
                        <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem;">
                          <%= gig_song.song.key %>
                        </span>
                      </div>
                    </div>
                    <% if gig_song.song.url.present? %>
                      <div class="actions" onclick="event.stopPropagation();" style="display: flex; gap: 5px; flex-shrink: 0;">
                        <a href="<%= gig_song.song.url %>" target="_blank" class="btn btn-small" style="font-size: 0.75rem; padding: 4px 8px; min-height: 28px;">ðŸŽµ</a>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px;">
            <h4>Gig Summary</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div class="detail-item">
                    <span class="detail-label">Total Songs:</span> <%= @gig.songs.count %>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Estimated Duration:</span> 
                    <% 
                      total_minutes = @gig.songs.sum do |s| 
                        if s.duration.present? && s.duration.match?(/^\d+:\d+$/)
                          parts = s.duration.split(':').map(&:to_i)
                          parts[0] + parts[1]/60.0
                        else
                          0
                        end
                      end
                    %>
                    <%= total_minutes > 0 ? "#{total_minutes.to_i}:#{((total_minutes % 1) * 60).round.to_s.rjust(2, '0')}" : 'N/A' %>
                </div>

            </div>
        </div>
    <% else %>
        <div style="text-align: center; padding: 40px;">
            <h3>No songs in this gig yet</h3>
            <p>Add some songs to get started!</p>
            <a href="/gigs/<%= @gig.id %>/manage_songs" class="btn btn-success">Manage Songs</a>
        </div>
    <% end %>
</div>

 