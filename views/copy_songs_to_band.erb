<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
    <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -4px; margin-right: 8px;">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        Copy Songs to <%= @band.name %>
    </h2>
</div>

<div style="margin-bottom: 20px; padding: 15px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38a169;">
    <p style="margin: 0; color: #2f855a; font-weight: 500;">
        ‚ÑπÔ∏è Select songs from the song catalog to copy to <%= @band.name %>'s repertoire. You can modify your copies without affecting the catalog versions.
    </p>
</div>

<div style="margin-bottom: 20px;">
    <%= erb :_search_input, locals: {
        placeholder: 'Search song catalog by title or artist...',
        clear_function: 'clearSearch()'
    } %>
</div>

<script>
// Initialize search functionality using shared utilities
DOMUtils.ready(function() {
    SearchUtils.initializeSearch('search-input', 500);
});

function selectAll() {
    const checkboxes = document.querySelectorAll('input[name="song_catalog_ids[]"]');
    const selectAllCheckbox = document.getElementById('select-all');
    checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('input[name="song_catalog_ids[]"]:checked');
    const count = checkboxes.length;
    const button = document.getElementById('copy-button');
    const countSpan = document.getElementById('selected-count');
    
    countSpan.textContent = count;
    button.disabled = count === 0;
    button.textContent = count === 0 ? 'Select songs to copy' : `Copy ${count} song${count === 1 ? '' : 's'} to ${button.dataset.bandName}`;
}

// Focus the search input when page loads
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        // Check if we came from a clear action (no search param but input was just cleared)
        const urlParams = new URLSearchParams(window.location.search);
        const hasSearchTerm = searchInput.value.trim() !== '';
        const wasCleared = !urlParams.has('search') && document.referrer.includes('search=');
        
        if (hasSearchTerm || wasCleared) {
            // Small delay to ensure the page is fully loaded
            setTimeout(function() {
                searchInput.focus();
                // Move cursor to end of text
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
            }, 100);
        }
    }
    
    // Add event listeners to all checkboxes
    const checkboxes = document.querySelectorAll('input[name="song_catalog_ids[]"]');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
    
    updateSelectedCount();
});
</script>

<% if @search.present? %>
    <div style="margin-bottom: 20px; padding: 10px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
        <p style="margin: 0; color: #4a5568;">
            Showing results for "<strong><%= @search %></strong>"
            (<%= @song_catalogs.count %> song<%= @song_catalogs.count == 1 ? '' : 's' %>)
        </p>
    </div>
<% end %>

<% if @song_catalogs.any? %>
    <form method="POST" action="/bands/<%= @band.id %>/copy_songs">
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 16px;">
                    <input type="checkbox" id="select-all" onchange="selectAll()" style="margin-right: 8px; transform: scale(1.2);">
                    Select All (<span id="selected-count">0</span> selected)
                </label>
                <button type="submit" id="copy-button" class="btn btn-success" data-band-name="<%= @band.name %>" disabled>
                    Select songs to copy
                </button>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <% @song_catalogs.each do |song_catalog| %>
                <div class="song-card" style="padding: 15px; margin-bottom: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="song_catalog_ids[]" value="<%= song_catalog.id %>" style="transform: scale(1.2); min-width: 20px; min-height: 20px;">
                            </label>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; color: #2d3748; margin-bottom: 5px; word-break: break-word;">
                                    <%= song_catalog.title %>
                                    <% if song_catalog.artist.present? %>
                                        <span style="color: #718096; font-weight: normal; font-size: 0.9rem;"> ‚Ä¢ <%= song_catalog.artist %></span>
                                    <% end %>
                                </div>
                                <div style="font-size: 0.8rem; color: #a0aec0; display: flex; flex-wrap: wrap; gap: 5px;">
                                    <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px;">
                                        <%= song_catalog.key %>
                                    </span>

                                    <% if song_catalog.tempo %>
                                        <span style="background: #38a169; color: white; padding: 2px 6px; border-radius: 10px;">
                                            <%= song_catalog.tempo %> BPM
                                        </span>
                                    <% end %>
                                    <% if song_catalog.genre.present? %>
                                        <span style="background: #ed8936; color: white; padding: 2px 6px; border-radius: 10px;">
                                            <%= song_catalog.genre %>
                                        </span>
                                    <% end %>
                                </div>
                            </div>
                        </div>
                        <div class="actions" style="margin-left: 15px; display: flex; gap: 5px; flex-shrink: 0;">
                            <% if song_catalog.url.present? %>
                                <a href="<%= song_catalog.url %>" target="_blank" class="btn" style="padding: 6px 12px; font-size: 0.8rem;">üéµ</a>
                            <% end %>
                            <a href="/song_catalogs/<%= song_catalog.id %>" class="btn" style="padding: 6px 12px; font-size: 0.8rem;">View</a>
                        </div>
                    </div>
                </div>
            <% end %>
        </div>
    </form>
<% else %>
    <div class="card">
        <h3>No songs available to copy!</h3>
        <p>
            <% if @search.present? %>
                No songs match your search criteria. Try adjusting your search or clearing it to see all available songs.
            <% else %>
                All songs have already been copied to <%= @band.name %>, or there are no songs in the catalog yet.
            <% end %>
        </p>
        <div class="actions">
            <% if @search.present? %>
                <a href="/bands/<%= @band.id %>/copy_songs" class="btn">Clear Search</a>
            <% else %>
                <a href="/song_catalogs/new" class="btn btn-success">Add Songs to Song Catalog</a>
            <% end %>
        </div>
    </div>
<% end %>