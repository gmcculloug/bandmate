<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
    <h2>üìã Copy Songs to <%= @band.name %></h2>
    <a href="/bands/<%= @band.id %>" class="btn">Back to Band</a>
</div>

<div style="margin-bottom: 20px; padding: 15px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38a169;">
    <p style="margin: 0; color: #2f855a; font-weight: 500;">
        ‚ÑπÔ∏è Select songs from the global library to copy to <%= @band.name %>'s repertoire. You can modify your copies without affecting the global versions.
    </p>
</div>

<div style="margin-bottom: 20px;">
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="search-input" value="<%= @search %>" placeholder="Search global songs by title or artist..." style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
        <button type="button" onclick="filterSongs()" class="btn" style="padding: 10px 20px;">üîç Filter</button>
        <% if @search.present? %>
            <a href="/bands/<%= @band.id %>/copy_songs" class="btn" style="padding: 10px 20px;">Clear</a>
        <% end %>
    </div>
</div>

<script>
let searchTimeout;

document.getElementById('search-input').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        filterSongs();
    }, 500);
});

document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        filterSongs();
    }
});

function filterSongs() {
    const searchTerm = document.getElementById('search-input').value;
    const currentUrl = new URL(window.location);
    
    if (searchTerm.trim() === '') {
        currentUrl.searchParams.delete('search');
    } else {
        currentUrl.searchParams.set('search', searchTerm);
    }
    
    window.location.href = currentUrl.toString();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('input[name="global_song_ids[]"]');
    const selectAllCheckbox = document.getElementById('select-all');
    checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('input[name="global_song_ids[]"]:checked');
    const count = checkboxes.length;
    const button = document.getElementById('copy-button');
    const countSpan = document.getElementById('selected-count');
    
    countSpan.textContent = count;
    button.disabled = count === 0;
    button.textContent = count === 0 ? 'Select songs to copy' : `Copy ${count} song${count === 1 ? '' : 's'} to ${button.dataset.bandName}`;
}

// Focus the search input when page loads if there's a search term
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput && searchInput.value.trim() !== '') {
        // Small delay to ensure the page is fully loaded
        setTimeout(function() {
            searchInput.focus();
            // Move cursor to end of text
            searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
        }, 100);
    }
    
    // Add event listeners to all checkboxes
    const checkboxes = document.querySelectorAll('input[name="global_song_ids[]"]');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
    
    updateSelectedCount();
});
</script>

<% if @search.present? %>
    <div style="margin-bottom: 20px; padding: 10px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
        <p style="margin: 0; color: #4a5568;">
            Showing results for "<strong><%= @search %></strong>"
            (<%= @global_songs.count %> song<%= @global_songs.count == 1 ? '' : 's' %>)
        </p>
    </div>
<% end %>

<% if @global_songs.any? %>
    <form method="POST" action="/bands/<%= @band.id %>/copy_songs">
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 16px;">
                    <input type="checkbox" id="select-all" onchange="selectAll()" style="margin-right: 8px; transform: scale(1.2);">
                    Select All (<span id="selected-count">0</span> selected)
                </label>
                <button type="submit" id="copy-button" class="btn btn-success" data-band-name="<%= @band.name %>" disabled>
                    Select songs to copy
                </button>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <% @global_songs.each do |global_song| %>
                <div class="song-card" style="padding: 15px; margin-bottom: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="global_song_ids[]" value="<%= global_song.id %>" style="transform: scale(1.2); min-width: 20px; min-height: 20px;">
                            </label>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; color: #2d3748; margin-bottom: 5px; word-break: break-word;">
                                    <%= global_song.title %>
                                    <% if global_song.artist.present? %>
                                        <span style="color: #718096; font-weight: normal; font-size: 0.9rem;"> ‚Ä¢ <%= global_song.artist %></span>
                                    <% end %>
                                </div>
                                <div style="font-size: 0.8rem; color: #a0aec0; display: flex; flex-wrap: wrap; gap: 5px;">
                                    <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px;">
                                        <%= global_song.key %>
                                    </span>
                                    <% if global_song.original_key.present? %>
                                        <span style="background: #9f7aea; color: white; padding: 2px 6px; border-radius: 10px;">
                                            Orig: <%= global_song.original_key %>
                                        </span>
                                    <% end %>
                                    <% if global_song.tempo %>
                                        <span style="background: #38a169; color: white; padding: 2px 6px; border-radius: 10px;">
                                            <%= global_song.tempo %> BPM
                                        </span>
                                    <% end %>
                                    <% if global_song.genre.present? %>
                                        <span style="background: #ed8936; color: white; padding: 2px 6px; border-radius: 10px;">
                                            <%= global_song.genre %>
                                        </span>
                                    <% end %>
                                </div>
                            </div>
                        </div>
                        <div class="actions" style="margin-left: 15px; display: flex; gap: 5px; flex-shrink: 0;">
                            <% if global_song.url.present? %>
                                <a href="<%= global_song.url %>" target="_blank" class="btn" style="padding: 6px 12px; font-size: 0.8rem;">üéµ</a>
                            <% end %>
                            <a href="/global_songs/<%= global_song.id %>" class="btn" style="padding: 6px 12px; font-size: 0.8rem;">View</a>
                        </div>
                    </div>
                </div>
            <% end %>
        </div>
    </form>
<% else %>
    <div class="card">
        <h3>No songs available to copy!</h3>
        <p>
            <% if @search.present? %>
                No global songs match your search criteria. Try adjusting your search or clearing it to see all available songs.
            <% else %>
                All global songs have already been copied to <%= @band.name %>, or there are no global songs yet.
            <% end %>
        </p>
        <div class="actions">
            <% if @search.present? %>
                <a href="/bands/<%= @band.id %>/copy_songs" class="btn">Clear Search</a>
            <% else %>
                <a href="/global_songs/new" class="btn btn-success">Add Songs to Global Library</a>
            <% end %>
            <a href="/bands/<%= @band.id %>" class="btn">Back to Band</a>
        </div>
    </div>
<% end %>