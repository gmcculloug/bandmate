<div style="max-width: 600px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>🎸 Edit Band</h2>
        <a href="/profile" class="btn">Back to Settings</a>
    </div>

    <% if @errors %>
        <div class="errors" style="margin-bottom: 20px;">
            <% @errors.each do |error| %>
                <p><%= error %></p>
            <% end %>
        </div>
    <% end %>

    <% if @band.owned_by?(current_user) %>
        <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
            <p style="margin: 0; color: #0c4a6e; font-weight: 500;">
                👑 You are the owner of this band. You can transfer ownership to another member if needed.
            </p>
        </div>
    <% end %>

    <div class="card" style="margin-bottom: 30px;">
        <h3>👥 Band Members</h3>
        <p style="color: #666; margin-bottom: 15px;">
            Any band member can add or remove other members. The band owner cannot be removed and must transfer ownership first.
        </p>
        
        <% if @user_error %>
            <div class="errors" style="margin-bottom: 20px;">
                <p><%= @user_error %></p>
            </div>
        <% end %>
        
        <% if @user_success %>
            <div class="success" style="margin-bottom: 20px;">
                <p><%= @user_success %></p>
            </div>
        <% end %>

        <div style="margin-bottom: 20px;">
            <% if @band.users.any? %>
                <div style="margin-bottom: 20px;">
                    <h4>Current Members</h4>
                    <% @band.users.order(:username).each do |user| %>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; margin-bottom: 5px;">
                            <span style="font-weight: 500;">
                                <%= user.username %>
                                <% if user == current_user %>
                                    <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">You</span>
                                <% end %>
                                <% if user == @band.owner %>
                                    <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">👑 Owner</span>
                                <% end %>
                            </span>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <% if @band.users.count > 1 %>
                                    <% if user == current_user %>
                                        <form method="POST" action="/bands/<%= @band.id %>/remove_user" style="display: inline;">
                                            <input type="hidden" name="user_id" value="<%= user.id %>">
                                            <button type="submit" class="btn btn-danger" style="font-size: 0.8rem; padding: 3px 8px;" onclick="return confirm('Leave this band? You will no longer have access to its songs and set lists.')">Leave Band</button>
                                        </form>
                                    <% elsif user != @band.owner %>
                                        <form method="POST" action="/bands/<%= @band.id %>/remove_user" style="display: inline;">
                                            <input type="hidden" name="user_id" value="<%= user.id %>">
                                            <button type="submit" class="btn btn-danger" style="font-size: 0.8rem; padding: 3px 8px;" onclick="return confirm('Remove <%= user.username %> from this band?')">Remove</button>
                                        </form>
                                    <% end %>
                                    
                                    <% if @band.owned_by?(current_user) && user != current_user %>
                                        <form method="POST" action="/bands/<%= @band.id %>/transfer_ownership" style="display: inline;">
                                            <input type="hidden" name="new_owner_id" value="<%= user.id %>">
                                            <button type="submit" class="btn btn-warning" style="font-size: 0.8rem; padding: 3px 8px;" onclick="return confirm('Transfer ownership to <%= user.username %>? This action cannot be undone.')">Make Owner</button>
                                        </form>
                                    <% end %>
                                <% elsif user == current_user %>
                                    <span style="font-size: 0.8rem; color: #999; padding: 3px 8px;">Last member</span>
                                <% end %>
                            </div>
                        </div>
                    <% end %>
                </div>
            <% end %>

            <h4>Add New Member</h4>
            <form method="POST" action="/bands/<%= @band.id %>/add_user" style="display: flex; gap: 10px; align-items: end;">
                <div style="flex: 1;">
                    <label for="username" style="display: block; margin-bottom: 5px; font-weight: bold;">Username</label>
                    <input type="text" id="username" name="username" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" placeholder="Enter username to add">
                </div>
                <button type="submit" class="btn btn-success">Add Member</button>
            </form>
            <small style="color: #666; margin-top: 5px; display: block;">Enter the exact username of the user you want to add to this band.</small>
        </div>
    </div>

    <div class="card">
        <form method="POST" action="/bands/<%= @band.id %>">
            <input type="hidden" name="_method" value="PUT">
            
            <div style="margin-bottom: 20px;">
                <label for="band_name" style="display: block; margin-bottom: 5px; font-weight: bold;">Band Name *</label>
                <input type="text" id="band_name" name="band[name]" value="<%= @band.name %>" required autofocus style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label for="band_notes" style="display: block; margin-bottom: 5px; font-weight: bold;">Notes</label>
                <textarea id="band_notes" name="band[notes]" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; font-family: inherit;"><%= @band.notes %></textarea>
                <small style="color: #666;">Optional notes about the band, members, style, etc.</small>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-success">Update Band</button>
                <a href="/bands/<%= @band.id %>" class="btn">Cancel</a>
            </div>
        </form>
    </div>

    <!-- Google Calendar Integration Section -->
    <div class="card" style="margin-top: 30px;">
        <h3>📅 Google Calendar Integration</h3>
        <p style="color: #666; margin-bottom: 20px;">
            Sync your band's gigs to a Google Calendar. All band members can subscribe to this calendar to see gigs in their personal Google Calendar.
        </p>

        <% if @google_calendar_error %>
            <div class="errors" style="margin-bottom: 20px;">
                <p><%= @google_calendar_error %></p>
            </div>
        <% end %>

        <% if @google_calendar_success %>
            <div class="success" style="margin-bottom: 20px;">
                <p><%= @google_calendar_success %></p>
            </div>
        <% end %>

        <form method="POST" action="/bands/<%= @band.id %>/google_calendar_settings">
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" 
                           name="google_calendar_enabled" 
                           value="1" 
                           <%= 'checked' if @band.google_calendar_enabled? %>
                           onchange="toggleCalendarFields(this)">
                    <span style="font-weight: bold;">Enable Google Calendar Sync</span>
                </label>
            </div>

            <div id="calendar-fields" style="<%= 'display: none;' unless @band.google_calendar_enabled? %>">
                <div style="margin-bottom: 20px;">
                    <label for="google_calendar_id" style="display: block; margin-bottom: 5px; font-weight: bold;">Google Calendar ID *</label>
                    <input type="text" 
                           id="google_calendar_id" 
                           name="google_calendar_id" 
                           value="<%= @band.google_calendar_id %>" 
                           placeholder="your-email@gmail.com or calendar-id@group.calendar.google.com"
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Enter your Google Calendar ID. This can be your email address or a shared calendar ID.
                        <br><strong>How to find your Calendar ID:</strong>
                        <br>1. Go to <a href="https://calendar.google.com" target="_blank">Google Calendar</a>
                        <br>2. Click the three dots next to your calendar name
                        <br>3. Select "Settings and sharing"
                        <br>4. Copy the "Calendar ID" from the "Integrate calendar" section
                    </small>
                </div>

                <div style="margin-bottom: 20px;">
                    <button type="button" 
                            onclick="testCalendarConnection()" 
                            class="btn btn-secondary" 
                            style="margin-right: 10px;">
                        Test Connection
                    </button>
                    <button type="button" 
                            onclick="syncAllGigs()" 
                            class="btn btn-primary">
                        Sync All Gigs
                    </button>
                </div>

                <div id="connection-status" style="margin-bottom: 20px;"></div>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-success">Save Calendar Settings</button>
            </div>
        </form>
    </div>

    <script>
        function toggleCalendarFields(checkbox) {
            const fields = document.getElementById('calendar-fields');
            const calendarIdField = document.getElementById('google_calendar_id');
            
            if (checkbox.checked) {
                fields.style.display = 'block';
                calendarIdField.required = true;
            } else {
                fields.style.display = 'none';
                calendarIdField.required = false;
            }
        }

        function testCalendarConnection() {
            const statusDiv = document.getElementById('connection-status');
            const calendarId = document.getElementById('google_calendar_id').value;
            
            if (!calendarId) {
                statusDiv.innerHTML = '<div class="errors"><p>Please enter a Calendar ID first</p></div>';
                return;
            }

            statusDiv.innerHTML = '<div style="color: #666;">Testing connection...</div>';

            fetch(`/bands/<%= @band.id %>/test_google_calendar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `google_calendar_id=${encodeURIComponent(calendarId)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<div class="success"><p>✅ Connection successful! Calendar: ${data.calendar_name}</p></div>`;
                } else {
                    statusDiv.innerHTML = `<div class="errors"><p>❌ Connection failed: ${data.error}</p></div>`;
                }
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="errors"><p>❌ Error testing connection: ${error.message}</p></div>`;
            });
        }

        function syncAllGigs() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<div style="color: #666;">Syncing all gigs to Google Calendar...</div>';

            fetch(`/bands/<%= @band.id %>/sync_google_calendar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<div class="success"><p>✅ Successfully synced ${data.synced_count}/${data.total_count} gigs to Google Calendar!</p></div>`;
                } else {
                    let message = `❌ Sync failed: ${data.synced_count || 0}/${data.total_count || 0} gigs synced successfully.`;
                    if (data.error) {
                        message += ` Error: ${data.error}`;
                    }
                    if (data.errors && data.errors.length > 0) {
                        message += ` Issues: ${data.errors.join(', ')}`;
                    }
                    statusDiv.innerHTML = `<div class="errors"><p>${message}</p></div>`;
                }
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="errors"><p>❌ Error syncing gigs: ${error.message}</p></div>`;
            });
        }
    </script>
</div> 