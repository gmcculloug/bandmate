<h2>✏️ Edit Gig: <%= @gig.name %></h2>

<% if defined?(@errors) && @errors.any? %>
    <div class="errors">
        <ul>
            <% @errors.each do |error| %>
                <li><%= error %></li>
            <% end %>
        </ul>
    </div>
<% end %>

<form method="POST" action="/gigs/<%= @gig.id %>" class="card">
    <input type="hidden" name="_method" value="PUT">
    
    <div class="form-group">
        <label for="gig_venue_id">Venue</label>
        <select id="gig_venue_id" name="venue_id" autofocus>
            <option value="">Select Venue (Optional)</option>
            <% @venues.each do |venue| %>
                <option value="<%= venue.id %>" data-venue-name="<%= venue.name %>" <%= 'selected' if @gig.venue_id == venue.id %>><%= venue.name %> - <%= venue.location %></option>
            <% end %>
        </select>
    </div>

    <div class="form-group">
        <label for="gig_name">Gig Name *</label>
        <input type="text" id="gig_name" name="name" value="<%= @gig.name %>" required>
    </div>

    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
        <style>
            @media (min-width: 768px) {
                .form-grid {
                    grid-template-columns: 1fr 1fr !important;
                }
            }
        </style>
        <div class="form-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
            <div class="form-group">
                <label for="gig_performance_date">Performance Date *</label>
                <input type="date" id="gig_performance_date" name="performance_date" value="<%= @gig.performance_date&.strftime('%Y-%m-%d') %>" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="gig_start_time">Start Time</label>
                    <input type="time" id="gig_start_time" name="start_time" value="<%= @gig.start_time&.strftime('%H:%M') %>">
                </div>

                <div class="form-group">
                    <label for="gig_end_time">End Time</label>
                    <input type="time" id="gig_end_time" name="end_time" value="<%= @gig.end_time&.strftime('%H:%M') %>">
                </div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label for="gig_notes">Notes</label>
        <textarea id="gig_notes" name="notes" rows="3" placeholder="Any notes about this set list (special instructions, equipment needs, etc.)"><%= @gig.notes %></textarea>
    </div>

    <div class="actions">
        <button type="submit" class="btn btn-success">Update Gig</button>
        <a href="/gigs/<%= @gig.id %>" class="btn">Cancel</a>
    </div>
</form>


<script>
// Venue change detection for gig name auto-update
document.addEventListener('DOMContentLoaded', function() {
    const venueSelect = document.getElementById('gig_venue_id');
    const gigNameInput = document.getElementById('gig_name');
    let previousVenueName = '';
    
    // Initialize previousVenueName based on currently selected venue
    const initialSelectedOption = venueSelect.options[venueSelect.selectedIndex];
    if (initialSelectedOption && initialSelectedOption.dataset.venueName) {
        previousVenueName = initialSelectedOption.dataset.venueName;
    }
    
    venueSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const newVenueName = selectedOption.dataset.venueName || '';
        
        // Auto-populate if gig name is blank
        if (gigNameInput.value.trim() === '') {
            if (selectedOption.value && newVenueName) {
                gigNameInput.value = newVenueName;
            }
        }
        // Replace if current gig name matches the previous venue name
        else if (gigNameInput.value.trim() === previousVenueName && newVenueName) {
            gigNameInput.value = newVenueName;
        }
        
        // Update the previous venue name for next comparison
        previousVenueName = newVenueName;
    });
});

</script>

<div class="card" style="margin-top: 20px; background: #fed7d7; border: 1px solid #fc8181;">
    <h3 style="color: #c53030;">Danger Zone</h3>
    <p>Deleting this gig is permanent and cannot be undone.</p>
    <form method="POST" action="/gigs/<%= @gig.id %>" style="margin-top: 15px;">
        <input type="hidden" name="_method" value="DELETE">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this gig? This action cannot be undone.')">Delete Gig</button>
    </form>
</div> 