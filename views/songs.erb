<div class="page-header">
    <h2 class="page-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -4px; margin-right: 8px;">
            <path d="M9 18V5l12-2v13"></path>
            <circle cx="6" cy="18" r="3"></circle>
            <circle cx="18" cy="16" r="3"></circle>
        </svg>
        Songs (<%= @songs.count %>)
    </h2>
    <div class="page-actions">
        <a href="/song_catalogs" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
            Song Catalog
        </a>
        <a href="/song_catalogs/new" class="btn btn-success">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Add Songs
        </a>
    </div>
</div>

<div style="margin-bottom: 20px;">
    <div style="display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap;">
        <div style="position: relative; flex: 1; max-width: 400px; min-width: 250px;">
            <input type="text" id="search-input" value="<%= @search %>" placeholder="Search songs by title or artist..." style="width: 100%; padding: 10px 40px 10px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
            <% if @search.present? %>
                <a href="#" onclick="clearSearch(); return false;" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #718096; font-size: 18px; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px;">✕</a>
            <% end %>
        </div>

        <button type="button"
                id="practice-filter-btn"
                onclick="togglePracticeFilter()"
                <% if @practice_songs_count == 0 %>disabled<% end %>
                style="padding: 10px 16px; border: 2px solid <%= @practice_filter ? '#f59e0b' : '#e2e8f0' %>; border-radius: 8px; font-size: 14px; cursor: <%= @practice_songs_count == 0 ? 'not-allowed' : 'pointer' %>; background: <%= @practice_filter ? '#fef3c7' : '#ffffff' %>; color: <%= @practice_filter ? '#d97706' : (@practice_songs_count == 0 ? '#9ca3af' : '#374151') %>; transition: all 0.2s ease; white-space: nowrap; display: flex; align-items: center; gap: 6px; font-weight: 500;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Practice Songs
            <% if @practice_songs_count > 0 %>
                <span style="background: <%= @practice_filter ? '#d97706' : '#6b7280' %>; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; min-width: 20px; text-align: center;">
                    <%= @practice_songs_count %>
                </span>
            <% end %>
        </button>
    </div>
</div>

<script>
let searchTimeout;

document.getElementById('search-input').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        filterSongs();
    }, 500);
});

document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        filterSongs();
    }
});

function filterSongs() {
    const searchTerm = document.getElementById('search-input').value;
    const currentUrl = new URL(window.location);
    
    if (searchTerm.trim() === '') {
        currentUrl.searchParams.delete('search');
    } else {
        currentUrl.searchParams.set('search', searchTerm);
    }
    
    window.location.href = currentUrl.toString();
}

function clearSearch() {
    const searchInput = document.getElementById('search-input');
    searchInput.value = '';
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.delete('search');
    window.location.href = currentUrl.toString();

    // Focus will be restored by the DOMContentLoaded handler when the page reloads
}

function togglePracticeFilter() {
    const currentUrl = new URL(window.location);
    const currentPracticeFilter = currentUrl.searchParams.get('practice') === 'true';

    if (currentPracticeFilter) {
        // Remove practice filter
        currentUrl.searchParams.delete('practice');
    } else {
        // Add practice filter
        currentUrl.searchParams.set('practice', 'true');
    }

    window.location.href = currentUrl.toString();
}

// Focus the search input when page loads and add global keyboard handling
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        // Check if we came from a clear action (no search param but input was just cleared)
        const urlParams = new URLSearchParams(window.location.search);
        const hasSearchTerm = searchInput.value.trim() !== '';
        const wasCleared = !urlParams.has('search') && document.referrer.includes('search=');

        if (hasSearchTerm || wasCleared) {
            // Small delay to ensure the page is fully loaded
            setTimeout(function() {
                searchInput.focus();
                // Move cursor to end of text
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
            }, 100);
        }
    }

    // Global keyboard event handler
    document.addEventListener('keydown', function(e) {
        const activeElement = document.activeElement;
        const isTypingInInput = activeElement.tagName === 'INPUT' ||
                                activeElement.tagName === 'TEXTAREA' ||
                                activeElement.isContentEditable;
        const hasModifier = e.altKey || e.ctrlKey || e.metaKey;

        // Handle ESC key to clear search
        if (e.key === 'Escape') {
            if (searchInput && searchInput.value.trim() !== '') {
                e.preventDefault();
                clearSearch();
                return;
            }
        }

        // Global text input handling - direct text to search box
        if (!isTypingInInput && !hasModifier && searchInput) {
            // Check if it's a printable character or backspace/delete
            const isPrintableChar = e.key.length === 1;
            const isBackspace = e.key === 'Backspace';
            const isDelete = e.key === 'Delete';

            if (isPrintableChar) {
                e.preventDefault();
                searchInput.focus();

                // Clear existing content and add the new character
                searchInput.value = e.key;

                // Move cursor to end
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);

                // Trigger input event to start search
                const inputEvent = new Event('input');
                searchInput.dispatchEvent(inputEvent);
            } else if ((isBackspace || isDelete) && searchInput.value.trim() !== '') {
                e.preventDefault();
                searchInput.focus();

                if (isBackspace) {
                    // Remove last character
                    searchInput.value = searchInput.value.slice(0, -1);
                } else if (isDelete) {
                    // Clear all content
                    searchInput.value = '';
                }

                // Move cursor to end
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);

                // Trigger input event
                const inputEvent = new Event('input');
                searchInput.dispatchEvent(inputEvent);
            }
        }
    });
});

// Update practice filter button count and state
function updatePracticeFilterButton(practiceCountChange) {
    const filterBtn = document.getElementById('practice-filter-btn');
    if (!filterBtn) return;

    // Get current count from the badge or parse from button text
    const countBadge = filterBtn.querySelector('span');
    let currentCount = 0;
    if (countBadge) {
        currentCount = parseInt(countBadge.textContent) || 0;
    }

    // Update count
    const newCount = Math.max(0, currentCount + practiceCountChange);

    // Update button state based on new count
    if (newCount === 0) {
        // Disable button and remove badge
        filterBtn.disabled = true;
        filterBtn.style.cursor = 'not-allowed';
        filterBtn.style.color = '#9ca3af';
        if (countBadge) {
            countBadge.remove();
        }
    } else {
        // Enable button and update/add badge
        filterBtn.disabled = false;
        filterBtn.style.cursor = 'pointer';

        // Update or create badge
        if (countBadge) {
            countBadge.textContent = newCount;
        } else {
            // Create new badge
            const badge = document.createElement('span');
            badge.style.cssText = 'background: #6b7280; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; min-width: 20px; text-align: center;';
            badge.textContent = newCount;
            filterBtn.appendChild(badge);
        }

        // Update button color if not currently filtered
        const currentUrl = new URL(window.location);
        const isPracticeFiltered = currentUrl.searchParams.get('practice') === 'true';
        if (!isPracticeFiltered) {
            filterBtn.style.color = '#374151';
        }
    }
}

// Practice state toggle functionality
function togglePracticeState(songId, button) {
    // Update button state immediately for responsiveness
    const wasPractice = button.classList.contains('active');
    const newPracticeState = !wasPractice;

    // Update button appearance
    if (newPracticeState) {
        button.classList.add('active');
        button.textContent = 'P';
        button.style.background = '#28a745';
        button.style.borderColor = '#28a745';
        button.title = 'Mark as ready (click to toggle)';
    } else {
        button.classList.remove('active');
        button.textContent = 'P';
        button.style.background = '#6c757d';
        button.style.borderColor = '#6c757d';
        button.title = 'Mark as practice (click to toggle)';
    }

    // Find the song card and update visual indicators
    const songCard = button.closest('.song-card');
    const practiceBadge = songCard.querySelector('.practice-badge');

    if (newPracticeState) {
        songCard.classList.add('practice-song');
        songCard.style.setProperty('background', '#fef3c7', 'important');
        songCard.style.setProperty('border', '2px solid #f59e0b', 'important');
        songCard.style.setProperty('box-shadow', '0 0 8px rgba(245, 158, 11, 0.3)', 'important');
        songCard.style.setProperty('transition', 'all 0.2s ease', 'important');

        // Add practice badge if it doesn't exist
        if (!practiceBadge) {
            const titleDiv = songCard.querySelector('div[style*="font-weight: bold"]');
            const badge = document.createElement('span');
            badge.className = 'practice-badge';
            badge.style.cssText = 'background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;';
            badge.textContent = 'P';
            titleDiv.insertBefore(badge, titleDiv.firstChild);
        }
    } else {
        songCard.classList.remove('practice-song');
        songCard.style.setProperty('background', '', 'important');
        songCard.style.setProperty('border', '', 'important');
        songCard.style.setProperty('box-shadow', '', 'important');
        songCard.style.setProperty('transition', 'all 0.2s ease', 'important');

        // Remove practice badge if it exists
        if (practiceBadge) {
            practiceBadge.remove();
        }
    }

    // Send API call to update server
    fetch(`/songs/${songId}/toggle_practice`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            console.error('Failed to update practice state on server:', data);
            // Revert UI changes on error
            if (newPracticeState) {
                button.classList.remove('active');
                button.textContent = 'P';
                button.style.background = '#6c757d';
                button.style.borderColor = '#6c757d';

                // Revert song card styling
                songCard.classList.remove('practice-song');
                songCard.style.setProperty('background', '', 'important');
                songCard.style.setProperty('border', '', 'important');
                songCard.style.setProperty('box-shadow', '', 'important');
                if (practiceBadge) {
                    practiceBadge.remove();
                }
                // Revert practice filter button count
                updatePracticeFilterButton(-1);
            } else {
                button.classList.add('active');
                button.textContent = 'P';
                button.style.background = '#28a745';
                button.style.borderColor = '#28a745';

                // Revert song card styling
                songCard.classList.add('practice-song');
                songCard.style.setProperty('background', '#fef3c7', 'important');
                songCard.style.setProperty('border', '2px solid #f59e0b', 'important');
                songCard.style.setProperty('box-shadow', '0 0 8px rgba(245, 158, 11, 0.3)', 'important');
                if (!practiceBadge) {
                    const titleDiv = songCard.querySelector('div[style*="font-weight: bold"]');
                    const badge = document.createElement('span');
                    badge.className = 'practice-badge';
                    badge.style.cssText = 'background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;';
                    badge.textContent = 'P';
                    titleDiv.insertBefore(badge, titleDiv.firstChild);
                }
                // Revert practice filter button count
                updatePracticeFilterButton(1);
            }
        } else {
            // Update practice filter button count
            const countChange = newPracticeState ? 1 : -1;
            updatePracticeFilterButton(countChange);
        }
    })
    .catch(error => {
        console.error('Error updating practice state:', error);
        // Revert UI changes on error
        if (newPracticeState) {
            button.classList.remove('active');
            button.textContent = 'P';
            button.style.background = '#6c757d';
            button.style.borderColor = '#6c757d';

            // Revert song card styling
            songCard.classList.remove('practice-song');
            songCard.style.setProperty('background', '', 'important');
            songCard.style.setProperty('border', '', 'important');
            songCard.style.setProperty('box-shadow', '', 'important');
            if (practiceBadge) {
                practiceBadge.remove();
            }
            // Revert practice filter button count
            updatePracticeFilterButton(-1);
        } else {
            button.classList.add('active');
            button.textContent = 'P';
            button.style.background = '#28a745';
            button.style.borderColor = '#28a745';

            // Revert song card styling
            songCard.classList.add('practice-song');
            songCard.style.setProperty('background', '#fef3c7', 'important');
            songCard.style.setProperty('border', '2px solid #f59e0b', 'important');
            songCard.style.setProperty('box-shadow', '0 0 8px rgba(245, 158, 11, 0.3)', 'important');
            if (!practiceBadge) {
                const titleDiv = songCard.querySelector('div[style*="font-weight: bold"]');
                const badge = document.createElement('span');
                badge.className = 'practice-badge';
                badge.style.cssText = 'background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;';
                badge.textContent = 'P';
                titleDiv.insertBefore(badge, titleDiv.firstChild);
            }
            // Revert practice filter button count
            updatePracticeFilterButton(1);
        }
        alert('Failed to update practice state. Please try again.');
    });
}
</script>

<% if params[:copied] %>
    <div class="message message--success">
        ✅ Successfully copied <%= params[:copied] %> song<%= params[:copied].to_i == 1 ? '' : 's' %> to your band!
    </div>
<% end %>

<% if @search.present? %>
    <div class="message message--info">
        Showing results for "<strong><%= @search %></strong>"<%= @practice_filter ? " in Practice songs" : "" %>
        (<%= @songs.count %> song<%= @songs.count == 1 ? '' : 's' %>)
    </div>
<% elsif @practice_filter %>
    <div class="message message--info">
        Showing Practice songs only
        (<%= @songs.count %> song<%= @songs.count == 1 ? '' : 's' %>)
    </div>
<% end %>

<% if @songs.any? %>
    <div style="display: flex; flex-direction: column; gap: 2px;">
        <% @songs.each do |song| %>
            <% is_practice = song.practice_for_band?(current_band) %>
            <div class="song-card <%= 'practice-song' if is_practice %>" style="padding: 8px 12px; margin-bottom: 0; cursor: pointer; border-radius: 4px; transition: all 0.2s ease; <%= 'background: #fef3c7 !important; border: 2px solid #f59e0b !important; box-shadow: 0 0 8px rgba(245, 158, 11, 0.3) !important;' if is_practice %>" onclick="window.location.href='/songs/<%= song.id %>/edit'">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px;">
                        <div style="font-weight: bold; color: #2d3748; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                            <% if is_practice %>
                                <span class="practice-badge" style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">P</span>
                            <% end %>
                            <%= song.title %>
                            <% if song.artist.present? %>
                                <span style="color: #718096; font-weight: normal; font-size: 0.9rem;"> • <%= song.artist %></span>
                            <% end %>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                            <button type="button" class="practice-toggle-btn <%= 'active' if is_practice %>"
                                    onclick="togglePracticeState('<%= song.id %>', this); event.stopPropagation();"
                                    title="<%= is_practice ? 'Mark as ready (click to toggle)' : 'Mark as practice (click to toggle)' %>"
                                    style="background: <%= is_practice ? '#28a745' : '#6c757d' %>; border: 1px solid <%= is_practice ? '#28a745' : '#6c757d' %>; cursor: pointer; padding: 3px 6px; border-radius: 4px; transition: all 0.2s ease; color: white; font-size: 0.65rem; min-width: 24px; min-height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                P
                            </button>
                            <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem;">
                                <%= song.key %>
                            </span>
                            <% if song.tempo %>
                                <span style="background: #38a169; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem;">
                                    <%= song.tempo %> BPM
                                </span>
                            <% end %>
                        </div>
                    </div>
                    <% if song.url.present? %>
                        <div class="actions" onclick="event.stopPropagation();" style="display: flex; gap: 5px; flex-shrink: 0;">
                            <a href="<%= song.url %>" target="_blank" class="btn btn-small" style="padding: 4px 8px; font-size: 0.75rem; min-height: 28px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -1px;"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg></a>
                        </div>
                    <% end %>
                </div>
            </div>
        <% end %>
    </div>
<% else %>
    <div class="card">
        <h3>No songs yet!</h3>
        <p>Get started by adding your first song to the library.</p>
    </div>
<% end %>

<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
    <a href="/songs/archived" style="color: #718096; text-decoration: none; font-size: 0.9rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><polyline points="21,8 21,21 3,21 3,8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>View Archived Songs</a>
</div> 