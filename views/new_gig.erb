<h2 id="new-gig-heading">ðŸ“‹ Create New Gig</h2>

<%= erb :_errors %>

<form method="POST" action="/gigs" class="card" aria-labelledby="new-gig-heading" novalidate>
    <div class="form-group">
        <label for="gig_venue_id">Venue</label>
        <select id="gig_venue_id" name="venue_id" autofocus>
            <option value="">Select Venue (Optional)</option>
            <% @venues.each do |venue| %>
                <option value="<%= venue.id %>" data-venue-name="<%= venue.name %>"><%= venue.name %> - <%= venue.location %></option>
            <% end %>
        </select>
    </div>

    <div class="form-group">
        <label for="gig_name">Gig Name *</label>
        <input type="text" id="gig_name" name="name" placeholder="e.g., Friday Night Set, Acoustic Session" required>
    </div>

    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
        <style>
            @media (min-width: 768px) {
                .form-grid {
                    grid-template-columns: 1fr 1fr !important;
                }
            }
        </style>
        <fieldset class="form-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px; border: none; padding: 0; margin: 0;">
            <legend class="sr-only">Performance Date and Time</legend>

            <div class="form-group">
                <label for="gig_performance_date">Performance Date *</label>
                <input type="date"
                       id="gig_performance_date"
                       name="performance_date"
                       required
                       aria-describedby="performance-date-help">
                <div id="performance-date-help" class="sr-only">Select the date for this performance</div>
            </div>

            <div class="form-group">
                <label for="gig_start_time">Start Time</label>
                <div class="modern-time-control"
                     role="group"
                     aria-labelledby="start-time-label"
                     aria-describedby="start-time-help">
                <div id="start-time-label" class="sr-only">Start time selection</div>
                <div id="start-time-help" class="sr-only">Choose a preset time or enter a custom time</div>
                    <div class="preset-times" role="group" aria-label="Quick time presets">
                        <button type="button" class="time-preset-btn" data-time="18:00" aria-label="Set start time to 6:00 PM">6:00 PM</button>
                        <button type="button" class="time-preset-btn" data-time="19:00" aria-label="Set start time to 7:00 PM">7:00 PM</button>
                        <button type="button" class="time-preset-btn" data-time="20:00" aria-label="Set start time to 8:00 PM">8:00 PM</button>
                        <button type="button" class="time-preset-btn" data-time="21:00" aria-label="Set start time to 9:00 PM">9:00 PM</button>
                    </div>
                    <div class="time-input-row">
                        <input type="text"
                               id="gig_start_time"
                               name="start_time"
                               placeholder="Select start time..."
                               readonly
                               aria-describedby="start-time-instructions">
                        <div id="start-time-instructions" class="sr-only">Use preset buttons above or enter custom time</div>

                        <select id="gig_duration"
                                name="duration"
                                class="duration-selector"
                                aria-label="Performance duration"
                                aria-describedby="duration-instructions">
                            <option value="">Duration</option>
                            <option value="60">1 hour</option>
                            <option value="90">1.5 hours</option>
                            <option value="120">2 hours</option>
                            <option value="150">2.5 hours</option>
                            <option value="180">3 hours</option>
                            <option value="240">4 hours</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <div id="duration-instructions" class="sr-only">Select expected performance duration</div>
                    </div>
                    <div class="duration-info" id="duration-info" style="display: none;"></div>
                </div>
            </div>
        </fieldset>
    </div>

    <div class="form-group" id="end-time-group" style="display: none;">
        <label for="gig_end_time">End Time</label>
        <input type="text"
               id="gig_end_time"
               name="end_time"
               placeholder="Select end time..."
               readonly
               aria-describedby="end-time-help">
        <div id="end-time-help" class="sr-only">End time is calculated automatically based on duration</div>
    </div>

    <div class="form-group">
        <label for="gig_notes">Notes</label>
        <textarea id="gig_notes"
                  name="notes"
                  rows="3"
                  placeholder="Any notes about this set list (special instructions, equipment needs, etc.)"
                  aria-describedby="notes-help">
        </textarea>
        <div id="notes-help" class="sr-only">Optional notes about special requirements, equipment, or instructions for this performance</div>
    </div>

    <%= erb :_form_actions, locals: { submit_text: 'Create Gig', cancel_url: '/gigs' } %>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const venueSelect = document.getElementById('gig_venue_id');
    const gigNameInput = document.getElementById('gig_name');
    const startTimeInput = document.getElementById('gig_start_time');
    const endTimeInput = document.getElementById('gig_end_time');
    const durationSelect = document.getElementById('gig_duration');
    const durationInfo = document.getElementById('duration-info');
    const endTimeGroup = document.getElementById('end-time-group');
    const presetTimeBtns = document.querySelectorAll('.time-preset-btn');
    let previousVenueName = '';
    let startTimePicker, endTimePicker;

    // Initialize Flatpickr for time inputs
    startTimePicker = flatpickr(startTimeInput, {
        enableTime: true,
        noCalendar: true,
        dateFormat: "h:i K",
        time_24hr: false,
        minuteIncrement: 15,
        onChange: function(selectedDates, dateStr) {
            // Update data-time attribute in real-time
            if (selectedDates.length > 0) {
                const date = selectedDates[0];
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                startTimeInput.setAttribute('data-time', `${hours}:${minutes}`);

                // Recalculate end time immediately if duration is selected
                if (durationSelect.value && durationSelect.value !== 'custom' && durationSelect.value !== '') {
                    calculateEndTime();
                }
            }
        },
        onClose: function(selectedDates, dateStr) {
            // Store as 24-hour format for form submission
            if (selectedDates.length > 0) {
                const date = selectedDates[0];
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                startTimeInput.setAttribute('data-time', `${hours}:${minutes}`);
            }

            updatePresetButtons();

            // Always recalculate end time if duration is selected (not custom)
            if (durationSelect.value && durationSelect.value !== 'custom' && durationSelect.value !== '') {
                calculateEndTime();
            }
        }
    });

    endTimePicker = flatpickr(endTimeInput, {
        enableTime: true,
        noCalendar: true,
        dateFormat: "h:i K",
        time_24hr: false,
        minuteIncrement: 15,
        onClose: function(selectedDates, dateStr) {
            // Store as 24-hour format for form submission
            if (selectedDates.length > 0) {
                const date = selectedDates[0];
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                endTimeInput.setAttribute('data-time', `${hours}:${minutes}`);
            }
        }
    });

    // Venue name auto-population
    venueSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const newVenueName = selectedOption.dataset.venueName || '';

        if (gigNameInput.value.trim() === '') {
            if (selectedOption.value && newVenueName) {
                gigNameInput.value = newVenueName;
            }
        }
        else if (gigNameInput.value.trim() === previousVenueName && newVenueName) {
            gigNameInput.value = newVenueName;
        }

        previousVenueName = newVenueName;
    });

    const initialSelectedOption = venueSelect.options[venueSelect.selectedIndex];
    if (initialSelectedOption && initialSelectedOption.dataset.venueName) {
        previousVenueName = initialSelectedOption.dataset.venueName;
    }

    // Preset time buttons
    presetTimeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const time24 = this.dataset.time;
            const [hours, minutes] = time24.split(':');

            // Set time in Flatpickr
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            startTimePicker.setDate(date);

            // Store 24-hour format
            startTimeInput.setAttribute('data-time', time24);

            // Update button states
            presetTimeBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Calculate end time if duration is selected
            if (durationSelect.value && durationSelect.value !== 'custom') {
                calculateEndTime();
            }
        });
    });

    // Duration selection
    durationSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            endTimeGroup.style.display = 'block';
            durationInfo.style.display = 'none';
        } else if (this.value === '') {
            endTimeGroup.style.display = 'none';
            durationInfo.style.display = 'none';
            endTimePicker.clear();
        } else {
            endTimeGroup.style.display = 'none';
            durationInfo.style.display = 'block';
            calculateEndTime();
        }
    });

    // Form submission - convert display values to 24-hour format
    document.querySelector('form').addEventListener('submit', function() {
        const startTime24 = startTimeInput.getAttribute('data-time');
        const endTime24 = endTimeInput.getAttribute('data-time');

        if (startTime24) {
            startTimeInput.name = 'start_time';
            startTimeInput.value = startTime24;
        }

        if (endTime24) {
            endTimeInput.name = 'end_time';
            endTimeInput.value = endTime24;
        }
    });

    function updatePresetButtons() {
        const currentTime = startTimeInput.getAttribute('data-time');
        presetTimeBtns.forEach(btn => {
            if (btn.dataset.time === currentTime) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function calculateEndTime() {
        const startTime24 = startTimeInput.getAttribute('data-time');
        const duration = parseInt(durationSelect.value);

        if (startTime24 && duration) {
            const [hours, minutes] = startTime24.split(':');
            const startDate = new Date();
            startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            const endDate = new Date(startDate.getTime() + duration * 60000);
            const endHours = endDate.getHours().toString().padStart(2, '0');
            const endMinutes = endDate.getMinutes().toString().padStart(2, '0');
            const endTime24 = `${endHours}:${endMinutes}`;

            // Set end time in Flatpickr and store 24-hour format
            endTimePicker.setDate(endDate);
            endTimeInput.setAttribute('data-time', endTime24);

            // Update duration display
            const endTime12h = formatTime12Hour(endTime24);
            durationInfo.textContent = `Ends at ${endTime12h}`;
        }
    }

    function formatTime12Hour(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
    }
});
</script>

 