services:
  bandmate:
    build: .
    ports:
      - "0.0.0.0:4567:4567"  # HTTPS port
    volumes:
      # Mount logs directory
      - ./logs:/app/logs
      # Optional: Mount SSL certificates if you have custom ones
      - ./ssl:/app/ssl
    environment:
      - RACK_ENV=production
      - PORT=4567
      - BANDMATE_ACCT_CREATION_SECRET=${BANDMATE_ACCT_CREATION_SECRET:-your_secret_here}
      # External PostgreSQL connection settings (for macOS host)
      # Use host.docker.internal for Docker, host.containers.internal for Podman
      - DATABASE_HOST=${DATABASE_HOST:-host.docker.internal}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_NAME=${DATABASE_NAME:-bandmate_production}
      - DATABASE_USERNAME=${DATABASE_USERNAME:-}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:4567/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: >
      sh -c "
        echo 'Connecting to external PostgreSQL at ${DATABASE_HOST}:${DATABASE_PORT}...' &&
        (bundle exec rake db:migrate || echo 'Migration failed or already applied, continuing...') &&
        echo 'Starting Bandmate application with HTTPS...' &&
        ruby app.rb
      "

# No internal volumes needed since using external PostgreSQL 